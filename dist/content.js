(function () {
	'use strict';

	var D=Object.defineProperty;var W=Object.getOwnPropertySymbols;var j=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var E=(N,T,v)=>T in N?D(N,T,{enumerable:!0,configurable:!0,writable:!0,value:v}):N[T]=v,F=(N,T)=>{for(var v in T||(T={}))j.call(T,v)&&E(N,v,T[v]);if(W)for(var v of W(T))B.call(T,v)&&E(N,v,T[v]);return N};var $={};(function(N){(function(){var T={direction:"horizontal",snapToLines:!0,linePosition:"auto",lineAlign:"start",textPosition:"auto",positionAlign:"auto",size:100,alignment:"center"},v=function(x){x||(x={"&amp":"&","&lt":"<","&gt":">","&lrm":"\u200E","&rlm":"\u200F","&nbsp":"\xA0"}),this.entities=x,this.parse=function(O,b){O=O.replace(/\0/g,"\uFFFD");var y=/\r\n|\r|\n/,n=Date.now(),i=0,t=O.split(y),s=!1,h=[],o=[];function f(u,m){o.push({message:u,line:i+1,col:m});}var r=t[i],l=r.length,e="WEBVTT",p=0,g=e.length;for(r[0]==="\uFEFF"&&(p=1,g+=1),(l<g||r.indexOf(e)!==0+p||l>g&&r[g]!==" "&&r[g]!=="	")&&f('No valid signature. (File needs to start with "WEBVTT".)'),i++;t[i]!=""&&t[i]!=null;){if(f("No blank line after the signature."),t[i].indexOf("-->")!=-1){s=!0;break}i++;}for(;t[i]!=null;){for(var c;!s&&t[i]=="";)i++;if(!s&&t[i]==null)break;c=Object.assign({},T,{id:"",startTime:0,endTime:0,pauseOnExit:!1,direction:"horizontal",snapToLines:!0,linePosition:"auto",lineAlign:"start",textPosition:"auto",positionAlign:"auto",size:100,alignment:"center",text:"",tree:null});var d=!0;if(t[i].indexOf("-->")==-1){if(c.id=t[i],/^NOTE($|[ \t])/.test(c.id)){for(i++;t[i]!=""&&t[i]!=null;)t[i].indexOf("-->")!=-1&&f("Cannot have timestamp in a comment."),i++;continue}if(i++,t[i]==""||t[i]==null){f("Cue identifier cannot be standalone.");continue}if(t[i].indexOf("-->")==-1){d=!1,f("Cue identifier needs to be followed by timestamp.");continue}}s=!1;var a=new P(t[i],f),S=0;if(h.length>0&&(S=h[h.length-1].startTime),d&&!a.parse(c,S)){for(c=null,i++;t[i]!=""&&t[i]!=null;){if(t[i].indexOf("-->")!=-1){s=!0;break}i++;}continue}for(i++;t[i]!=""&&t[i]!=null;){if(t[i].indexOf("-->")!=-1){f("Blank line missing before cue."),s=!0;break}c.text!=""&&(c.text+=`
`),c.text+=t[i],i++;}var w=new C(c.text,f,b,this.entities);c.tree=w.parse(c.startTime,c.endTime),h.push(c);}return h.sort(function(u,m){return u.startTime<m.startTime?-1:u.startTime>m.startTime?1:u.endTime>m.endTime?-1:u.endTime<m.endTime?1:0}),{cues:h,errors:o,time:Date.now()-n}};},P=function(n,O){var b=/[\u0020\t\f]/,y=/[^\u0020\t\f]/,n=n,i=0,t=function(r){O(r,i+1);};function s(r){for(;n[i]!=null&&r.test(n[i]);)i++;}function h(r){for(var l="";n[i]!=null&&r.test(n[i]);)l+=n[i],i++;return l}function o(){var r="minutes",l,e,p,g;if(n[i]==null){t("No timestamp found.");return}if(!/\d/.test(n[i])){t("Timestamp must start with a character in the range 0-9.");return}if(l=h(/\d/),(l.length>2||parseInt(l,10)>59)&&(r="hours"),n[i]!=":"){t("No time unit separator found.");return}if(i++,e=h(/\d/),e.length!=2){t("Must be exactly two digits.");return}if(r=="hours"||n[i]==":"){if(n[i]!=":"){t("No seconds found or minutes is greater than 59.");return}if(i++,p=h(/\d/),p.length!=2){t("Must be exactly two digits.");return}}else {if(l.length!=2){t("Must be exactly two digits.");return}p=e,e=l,l="0";}if(n[i]!="."){t('No decimal separator (".") found.');return}if(i++,g=h(/\d/),g.length!=3){t("Milliseconds must be given in three digits.");return}if(parseInt(e,10)>59){t("You cannot have more than 59 minutes.");return}if(parseInt(p,10)>59){t("You cannot have more than 59 seconds.");return}return parseInt(l,10)*60*60+parseInt(e,10)*60+parseInt(p,10)+parseInt(g,10)/1e3}function f(r,l){for(var e=r.split(b),p=[],g=0;g<e.length;g++)if(e[g]!=""){var c=e[g].indexOf(":"),d=e[g].slice(0,c),a=e[g].slice(c+1);if(p.indexOf(d)!=-1&&t("Duplicate setting."),p.push(d),a==""){t("No value for setting defined.");return}if(d=="vertical"){if(a!="rl"&&a!="lr"){t("Writing direction can only be set to 'rl' or 'rl'.");continue}l.direction=a;}else if(d=="line"){if(/,/.test(a)){var S=a.split(",");a=S[0];var w=S[1];}if(!/^[-\d](\d*)(\.\d+)?%?$/.test(a)){t("Line position takes a number or percentage.");continue}if(a.indexOf("-",1)!=-1){t("Line position can only have '-' at the start.");continue}if(a.indexOf("%")!=-1&&a.indexOf("%")!=a.length-1){t("Line position can only have '%' at the end.");continue}if(a[0]=="-"&&a[a.length-1]=="%"){t("Line position cannot be a negative percentage.");continue}var u=a,m=!1;if(a[a.length-1]=="%"&&(m=!0,u=a.slice(0,a.length-1),parseInt(a,10)>100)){t("Line position cannot be >100%.");continue}if(u===""||isNaN(u)||!isFinite(u)){t("Line position needs to be a number");continue}if(w!==void 0){if(!["start","center","end"].includes(w)){t("Line alignment needs to be one of start, center or end");continue}l.lineAlign=w;}l.snapToLines=!m,l.linePosition=parseFloat(u),parseFloat(u).toString()!==u&&(l.nonSerializable=!0);}else if(d=="position"){if(/,/.test(a)){var S=a.split(",");a=S[0];var A=S[1];}if(a[a.length-1]!="%"){t("Text position must be a percentage.");continue}if(parseInt(a,10)>100||parseInt(a,10)<0){t("Text position needs to be between 0 and 100%.");continue}if(u=a.slice(0,a.length-1),u===""||isNaN(u)||!isFinite(u)){t("Line position needs to be a number");continue}if(A!==void 0){if(!["line-left","center","line-right"].includes(A)){t("Position alignment needs to be one of line-left, center or line-right");continue}l.positionAlign=A;}l.textPosition=parseFloat(u);}else if(d=="size"){if(a[a.length-1]!="%"){t("Size must be a percentage.");continue}if(parseInt(a,10)>100){t("Size cannot be >100%.");continue}var I=a.slice(0,a.length-1);if(I===void 0||I===""||isNaN(I)){t("Size needs to be a number"),I=100;continue}else if(I=parseFloat(I),I<0||I>100){t("Size needs to be between 0 and 100%.");continue}l.size=I;}else if(d=="align"){var L=["start","center","end","left","right"];if(L.indexOf(a)==-1){t("Alignment can only be set to one of "+L.join(", ")+".");continue}l.alignment=a;}else t("Invalid setting.");}}this.parse=function(r,l){if(s(b),r.startTime=o(),r.startTime!=null){if(r.startTime<l&&t("Start timestamp is not greater than or equal to start timestamp of previous cue."),y.test(n[i])&&t("Timestamp not separated from '-->' by whitespace."),s(b),n[i]!="-"){t("No valid timestamp separator found.");return}if(i++,n[i]!="-"){t("No valid timestamp separator found.");return}if(i++,n[i]!=">"){t("No valid timestamp separator found.");return}if(i++,y.test(n[i])&&t("'-->' not separated from timestamp by whitespace."),s(b),r.endTime=o(),r.endTime!=null)return r.endTime<=r.startTime&&t("End timestamp is not greater than start timestamp."),y.test(n[i]),s(b),f(n.substring(i),r),!0}},this.parseTimestamp=function(){var r=o();if(n[i]!=null){t("Timestamp must not have trailing characters.");return}return r};},C=function(i,O,b,y){this.entities=y;var n=this,i=i,t=0,s=function(o){b!="metadata"&&O(o,t+1);};this.parse=function(o,f){function r(u){const m=F({},u);return u.children&&(m.children=u.children.map(r)),m.parent&&delete m.parent,m}var l={children:[]},e=l,p=[];function g(u){e.children.push({type:"object",name:u[1],classes:u[2],children:[],parent:e}),e=e.children[e.children.length-1];}function c(u){for(var m=e;m;){if(m.name==u)return !0;m=m.parent;}}for(;i[t]!=null;){var d=h();if(d[0]=="text")e.children.push({type:"text",value:d[1],parent:e});else if(d[0]=="start tag"){b=="chapters"&&s("Start tags not allowed in chapter title text.");var a=d[1];a!="v"&&a!="lang"&&d[3]!=""&&s("Only <v> and <lang> can have an annotation."),a=="c"||a=="i"||a=="b"||a=="u"||a=="ruby"||a=="rt"&&e.name=="ruby"?g(d):a=="v"?(c("v")&&s("<v> cannot be nested inside itself."),g(d),e.value=d[3],d[3]||s("<v> requires an annotation.")):a=="lang"?(g(d),e.value=d[3]):s("Incorrect start tag.");}else if(d[0]=="end tag")b=="chapters"&&s("End tags not allowed in chapter title text."),d[1]==e.name?e=e.parent:d[1]=="ruby"&&e.name=="rt"?e=e.parent.parent:s("Incorrect end tag.");else if(d[0]=="timestamp"){b=="chapters"&&s("Timestamp not allowed in chapter title text.");var S=new P(d[1],s),w=S.parseTimestamp();w!=null&&((w<=o||w>=f)&&s("Timestamp must be between start timestamp and end timestamp."),p.length>0&&p[p.length-1]>=w&&s("Timestamp must be greater than any previous timestamp."),e.children.push({type:"timestamp",value:w,parent:e}),p.push(w));}}for(;e.parent;)e.name!="v"&&s("Required end tag missing."),e=e.parent;return r(l)};function h(){for(var o="data",f="",r="",l=[];i[t-1]!=null||t==0;){var e=i[t];if(o=="data")if(e=="&")r=e,o="escape";else if(e=="<"&&f=="")o="tag";else {if(e=="<"||e==null)return ["text",f];f+=e;}else if(o=="escape")if(e=="<"||e==null){s("Incorrect escape.");let p;return (p=r.match(/^&#([0-9]+)$/))?f+=String.fromCharCode(p[1]):n.entities[r]?f+=n.entities[r]:f+=r,["text",f]}else if(e=="&")s("Incorrect escape."),f+=r,r=e;else if(/[a-z#0-9]/i.test(e))r+=e;else if(e==";"){let p;(p=r.match(/^&#(x?[0-9]+)$/))?f+=String.fromCharCode("0"+p[1]):n.entities[r+e]?f+=n.entities[r+e]:(p=Object.keys(y).find(g=>r.startsWith(g)))?f+=n.entities[p]+r.slice(p.length)+e:(s("Incorrect escape."),f+=r+";"),o="data";}else s("Incorrect escape."),f+=r+e,o="data";else if(o=="tag")if(e=="	"||e==`
`||e=="\f"||e==" ")o="start tag annotation";else if(e==".")o="start tag class";else if(e=="/")o="end tag";else if(/\d/.test(e))f=e,o="timestamp tag";else {if(e==">"||e==null)return e==">"&&t++,["start tag","",[],""];f=e,o="start tag";}else if(o=="start tag")if(e=="	"||e=="\f"||e==" ")o="start tag annotation";else if(e==`
`)r=e,o="start tag annotation";else if(e==".")o="start tag class";else {if(e==">"||e==null)return e==">"&&t++,["start tag",f,[],""];f+=e;}else if(o=="start tag class")if(e=="	"||e=="\f"||e==" ")r&&l.push(r),r="",o="start tag annotation";else if(e==`
`)r&&l.push(r),r=e,o="start tag annotation";else if(e==".")r&&l.push(r),r="";else {if(e==">"||e==null)return e==">"&&t++,r&&l.push(r),["start tag",f,l,""];r+=e;}else if(o=="start tag annotation"){if(e==">"||e==null)return e==">"&&t++,r=r.split(/[\u0020\t\f\r\n]+/).filter(function(p){if(p)return !0}).join(" "),["start tag",f,l,r];r+=e;}else if(o=="end tag"){if(e==">"||e==null)return e==">"&&t++,["end tag",f];f+=e;}else if(o=="timestamp tag"){if(e==">"||e==null)return e==">"&&t++,["timestamp",f];f+=e;}else s("Never happens.");t++;}}},M=function(){function x(n){const i=(""+(n-Math.floor(n)).toFixed(3)*1e3).padEnd(3,"0");let t=0,s=0,h=0;return n>=3600&&(t=Math.floor(n/3600)),s=Math.floor((n-3600*t)/60),h=Math.floor(n-3600*t-60*s),(t?t+":":"")+(""+s).padStart(2,"0")+":"+(""+h).padStart(2,"0")+"."+i}function O(n){var i="";const t=Object.keys(T).filter(s=>n[s]!==T[s]);return t.includes("direction")&&(i+=" vertical:"+n.direction),t.includes("alignment")&&(i+=" align:"+n.alignment),t.includes("size")&&(i+=" size:"+n.size+"%"),(t.includes("lineAlign")||t.includes("linePosition"))&&(i+=" line:"+n.linePosition+(n.snapToLines?"":"%")+(n.lineAlign&&n.lineAlign!=T.lineAlign?","+n.lineAlign:"")),(t.includes("textPosition")||t.includes("positionAlign"))&&(i+=" position:"+n.textPosition+"%"+(n.positionAlign&&n.positionAlign!==T.positionAlign?","+n.positionAlign:"")),i}function b(n){for(var i="",t=0;t<n.length;t++){var s=n[t];if(s.type=="text")i+=s.value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");else if(s.type=="object"){if(i+="<"+s.name,s.classes)for(var h=0;h<s.classes.length;h++)i+="."+s.classes[h];s.value&&(i+=" "+s.value),i+=">",s.children&&(i+=b(s.children)),i+="</"+s.name+">";}else s.type=="timestamp"?i+="<"+x(s.value)+">":i+="<"+s.value+">";}return i}function y(n){return (n.id?n.id+`
`:"")+x(n.startTime)+" --> "+x(n.endTime)+O(n)+`
`+b(n.tree.children)+`

`}this.serialize=function(n){for(var i=`WEBVTT

`,t=0;t<n.length;t++)i+=y(n[t]);return i};};function z(x){x.WebVTTParser=v,x.WebVTTCueTimingsAndSettingsParser=P,x.WebVTTCueTextParser=C,x.WebVTTSerializer=M;}typeof window!="undefined"&&z(window),z(N);})();})($);

	const T={free:"https://api-free.deepl.com/v2/translate",pro:"https://api.deepl.com/v2/translate "};let u="",p="";document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();function f(){m();}function m(){const t=document.querySelector("video");if(!t){setTimeout(()=>{m();},1e3);return}t.addEventListener("play",n=>{g(t);}),t.addEventListener("loadedmetadata",n=>{g(t);});}let h=[];async function g(t){let n=await chrome.storage.local.get(["api_type","deepl_auth","deepl_target"]);const r=t.querySelector("track");if(r&&r.src){const s=r.src;w(s).then(e=>{e&&(r.src=e);});return}r.addEventListener("cuechange",s=>{const e=[];for(let a=0;a<r.track.cues.length;a++){if(h.includes(r.track.cues[a].id))continue;const o=r.track.cues[a].id,l=x(r.track.cues[a].text);l.trim()!==""&&(e.push({index:a,id:o,text:l}),h.push(o));}e.length!==0&&y(e.map(({text:a})=>a),"free",n.deepl_auth,n.deepl_target).then(a=>{for(const o in e){const l=r.track.cues[e[o].index];l.text=a[o];}});});}async function w(t){if(u===t)return "";let n=await fetch(t).then(c=>c.text());if(p===n)return "";p=n;const s=new $.WebVTTParser().parse(n);if(s===null)return "";let e=await chrome.storage.local.get(["api_type","deepl_auth","deepl_target"]);if(!e.api_type||!e.deepl_auth||!e.deepl_target)return i("Settings Not found. Please Deepl API Settings."),"";const a=s.cues.map(c=>c.text),o=L(a),l=o.reduce((c,k)=>c+k.length,0);i("Translating... TextLength: "+l+" Target: "+e.deepl_target);const _=b(o,50),d=[];try{for(const c of _)d.push(...await y(c,e.api_type,e.deepl_auth,e.deepl_target));}catch(c){throw i("Translation Failed. Error: "+c.message),c}i("Translation is complete.");for(const c in a)d[c]&&(n=n.replace(a[c],"<b>"+d[c]+"</b>"));let A=new Blob([n],{type:"text/vtt"});return u=URL.createObjectURL(A),u}function L(t){return t.map(n=>x(n))}function x(t){return t.replaceAll("<b>","").replaceAll("</b>","").replaceAll(`
`," ").replaceAll("\u266A","").replaceAll("-","")}async function y(t,n,r,s){let e=new FormData;e.append("auth_key",r),e.append("source_lang","EN"),e.append("target_lang",s);for(const o of t)e.append("text",o);return (await fetch(T[n],{method:"post",body:e}).then(o=>{if(o.status===403)throw i("Deepl Authentication failure."),new Error("Authentication failure");return o.json()})).translations.map(({text:o})=>o)}function b(t,n){return t.reduce((r,s,e)=>e%n?r:[...r,t.slice(e,e+n)],[])}function i(t){console.log("[southpark-deepl-translate] "+t);const n=document.getElementById("southpark-deepl-translate");if(n){n.textContent=t;return}const r=document.querySelector("#media-container .edge-gui-timer");if(!r)return;const s=document.createElement("div");s.id="southpark-deepl-translate",s.textContent=t,r.append(s);}

})();
